<h2>Item-追加</h2>
<%= form_with model:@item, url:admins_items_path, class:"form-inline" do |f|%>
 <%= render 'shared/error_messages' %>
 <form>
 <div class="row g-3">
  <div class="col-md-6">
     <%= f.label :name, class:"form-label"%>
     <%= f.text_field :name, class: "form-control", placeholder: "Enter item name"%>
  </div>

  <div class="col-md-6">
     <%= f.label :price, class:"form-label"%>
     <%= f.number_field :price, class: "form-control", placeholder: "Enter item price"%>
  </div>

</div>
<div class="row g-3">
  <div class="col-12">
    <%= f.label :description, class:"form-label" %>
    <%= f.text_field :description, class: "form-control", placeholder: "Enter item description", rows:"3" %>
  </div>
  <div class="col-12">
    <%= f.label :category, class:"form-label" %>
    <%= f.select :category_id, [["boys", 1], ["girls", 2]], include_blank: "select" ,class:"form-control form-select dropdown" %>
    <%= f.label :images,"Item Images", class:"form-label" %>
      <div id="image-box-1">
        <div class="item-num-0" id="image-box_container">
          <%= f.fields_for :images do |i| %>
            <div class="preview-image-box">
                <div class="d-flex row" id="preview-image-box">
                  <label class="w-50" for="img-file">
                    <i class="fa fa-plus-circle add-image-icon justify-content-center d-flex h3" aria-hidden="true"></i>
                  </label>
                </div>
                <%= f.file_field :images,multiple: true, id: "img-file",style: "display: none;" %>
                  <div class="preview-image w-50" id="image-preview-container" style: "display: none;"></div>    
              </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-12">
      <%= f.label :tags, "Item Tags", class:"form-label" %>
      <div class="row">
        <% Tag.all.each do |tag| %>
          <div class="col-3">
            <%= check_box_tag "item[tag_ids][]", tag.id, @item.tags.include?(tag), id: "item_tag_ids_#{tag.id}" %>
            <%= label_tag "item_tag_ids_#{tag.id}", tag.name %>
          </div>
        <% end %>
      </div>
    </div>
    
  </div>
  <div class="col-12">
    <button type="submit" class="btn btn-primary">item add</button>
  </div>
</div>
</form>
<% end %>

<script>
$(function(){
  //DataTransferオブジェクトで、データを格納する箱を作る
  var dataBox = new DataTransfer();
  //querySelectorでfile_fieldを取得
  var file_field = document.querySelector('input[type=file]')
  //fileが選択された時に発火するイベント
  $('#img-file').change(function(){
    //選択したfileのオブジェクトをpropで取得
    var files = $('input[type="file"]').prop('files')[0];
    $.each(this.files, function(i, file){
      //FileReaderのreadAsDataURLで指定したFileオブジェクトを読み込む
      var fileReader = new FileReader();

      //DataTransferオブジェクトに対して、fileを追加
      dataBox.items.add(file)
      //DataTransferオブジェクトに入ったfile一覧をfile_fieldの中に代入
      file_field.files = dataBox.files

      var num = $('.item-image').length + 1 + i
      fileReader.readAsDataURL(file);
       //画像が10枚になったら超えたらドロップボックスを削除する
      if (num == 10){
        $('#image-box_container').css('display', 'none')   
      }
      //読み込みが完了すると、srcにfileのURLを格納
      fileReader.onloadend = function() {
        var src = fileReader.result
        var html= `<div class='image-block item-image col-4 col-md-6 col-lg-4 px-0' data-image="${file.name}">
                    <div class='item-image_content'>
                      <div class='item-image_content-icon'>
                        <img src=${src} class="w-100">
                      </div>
                    </div>
                    <div class='item-image_operetion'>
                      <div class='btn btn-danger item-image_operetion-delete'>削除</div>
                    </div>
                  </div>`
        //image_box__container要素の前にhtmlを差し込む
        $('#preview-image-box').prepend(html);
      };
      //image-box__containerのクラスを変更し、CSSでドロップボックスの大きさを変えてやる。
      $('#image-box_container').attr('class', `item-num-${num}`)
    });
  });
  //削除ボタンをクリックすると発火するイベント
  $(document).on("click", '.item-image_operetion-delete', function(){
    //プレビュー要素を取得
    var target_image = $(this).closest('.item-image');
    //プレビューを削除
    target_image.remove();
    //inputタグに入ったファイルを削除
    file_field.val("");
  });
});


</script>
